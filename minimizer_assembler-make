#!/usr/bin/make -rRf

# Use minimizers to scaffold assemblies
# Written by Lauren Coombe @lcoombe

list_files=$(shell seq 1 3)
min_targets=$(addsuffix .tsv, $(list_files))
fa_targets=$(addsuffix .scaffolds.fa, $(list_files))
bam_targets=$(addsuffix .scaffolds.fa.bam.bai, $(list_files))

# Prefix for output files
prefix=out

# Path to physlr installation
physlr_path=/projects/btl/lcoombe/git/physlr/src

# Path to minimizer assemble code
assemble_path=/projects/btl_scratch/lcoombe/assembly_merger/minimizer_assembler

# Reference

# Window size
w=1000

# Kmer size
k=64

# Number of threads
t=4

# Minimum assembly support for graph edge
assembly_support=2

# Reference genome (for analysis)
ref=/projects/btl/lcoombe/reference-genomes/celegans/celegansN2_referencegenome.fna

assemble: $(min_targets) \
	$(prefix).mx.dot

analysis: $(bam_targets)

all: assemble analysis

help:
	@echo "Assembly merging with minimizers"
	@echo "Usage: minimizer_assembler-make assemble prefix=<prefix> list_files='List of fasta files'"
	@echo "Commands:"
	@echo "t	Number of threads [4]"
	@echo "k	K-mer size for minimizers [64]"
	@echo "w	Window size for minimizers [1000]"
	@echo "assembly_support	Min. assembly support for an edge [2]"


.PHONY: all analysis assemble help
.DELETE_ON_ERROR: $(prefix).mx.dot
.SECONDARY:

%.fa.tsv: %.fa
	$(physlr_path)/physlr-indexlr -k $(k) -w $(w) $< > $@

$(prefix).mx.dot $(fa_targets): $(min_targets)
	$(assemble_path)/minimizer_assemble.py -p $(prefix) -w $(assembly_support) $^

%.dot.png: %.dot
	dot -Tpng -o $@ $<

%.fa.bam: %.fa
	minimap2 -a -x asm5 -r100000 -t $(t) $(ref) $< |samtools view -b |samtools sort -o $@

%.bam.bai: %.bam
	samtools index $<